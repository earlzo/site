<!doctype html><html class=no-js lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>使用Python导出扇贝应用打卡日历 - Life Log</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=//earlzo.me/css/style.css><link rel="shortcut icon" href=//earlzo.me/favicon.ico></head><body class=body><div class="container container--outer"><header class=header><div class=container><div class=logo><a class=logo__link href=//earlzo.me/ title="Life Log" rel=home><div class=logo__title>Life Log</div><div class=logo__tagline>Don&#39;t panic</div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>菜单</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=//earlzo.me/><span class=menu__text>Blog</span></a></li><li class=menu__item><a class=menu__link href=//earlzo.me/about/><span class=menu__text>About</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>使用Python导出扇贝应用打卡日历</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2017-03-25T14:15:48>2017-03-25</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=//earlzo.me/categories/python/ rel=category>Python</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>目录</div><div class=toc__menu></div></div><div class="content post__content clearfix"><p>我一直使用嘀嗒清单做待办清单，它支持丰富的数据导入导出功能，强大的时间定义和日历功能，让我有了将它作为习惯和目标管理工具的想法。</p><p>因为之前有使用其数据导入功能添加个人课表的<a href=http://hfut.readthedocs.io/zh_CN/latest/advanced.html#id3>经验</a>，所以这次我决定将我的扇贝打卡日历导出为ical文件再导入到嘀嗒清单。</p><p>既然是导出扇贝应用打卡日历，其核心就是使用一定的方式获取到我们所需要的数据。以往我们习惯的做法是通过网页爬虫解析页面得到我们所要抓取的数据，但对于有客户端的应用，我们首先应该想到的是对客户端数据进行抓包分析，一般就能够直接得到我们所需要的数据接口了。</p><p>在这里我使用的是<a href=https://www.charlesproxy.com>Charles</a>进行HTTP抓包。</p><p>我们首先打开Charles，在手机上注销掉扇贝单词的账号，设置网络代理用于抓包（如果手机没有安装Charles的根证书用于解密HTTPS需要先安装证书），然后填写我们的账号和密码进行登录抓包。</p><p>关于抓包及分析数据在这里我们就不做赘述了，基本接口在Charles显示的结果如下:</p><p><img src=img/Charles_2017-03-25_15-30-12.png alt=Charles_2017-03-25_15-30-12></p><p>因为请求的内容有个人的敏感数据，实际的接口操作我们只需要看代码即可:</p><pre><code class=language-Python># -*- coding:utf-8 -*-
import logging
import requests
import icalendar

from urllib.parse import urljoin
from datetime import datetime


def _init_logger():
    logger = logging.Logger(&quot;shanbay&quot;, logging.INFO)
    sh = logging.StreamHandler()
    # https://docs.python.org/3/library/logging.html#logrecord-attributes
    fmt = logging.Formatter('%(asctime)s[%(levelname)s]: %(message)s')
    sh.setFormatter(fmt)
    logger.addHandler(sh)
    return logger


logger = _init_logger()


class RequestError(Exception):
    pass


class Shanbay:
    _base_url = &quot;https://rest.shanbay.com/&quot;

    def __init__(self, account, password):
        self.session = requests.Session()
        self._login(account, password)
        self.user = self.get_user_info()

    def _urljoin(self, path):
        return urljoin(self._base_url, path)

    @staticmethod
    def _check_response_status(response_json):
        &quot;&quot;&quot;
        检查响应是否有错, 没有错误便返回data字段
        &quot;&quot;&quot;
        if &quot;status_code&quot; not in response_json:
            raise RequestError(response_json[&quot;msg&quot;])
        if response_json[&quot;status_code&quot;] != 0:
            raise RequestError(
                &quot;请求错误 {res[status_code]}: {res[msg]}&quot;.format(res=response_json)
            )
        return response_json[&quot;data&quot;]

    def _login(self, account, password):
        &quot;&quot;&quot;
        登陆接口
        :param account: 扇贝账号
        :param password: 扇贝账号密码
        :return: 登陆状态
        &quot;&quot;&quot;
        # 直接登陆扇贝, 不存储用户名和密码
        login_status = self.session.put(
            self._urljoin(&quot;api/v1/account/login/&quot;),
            json={
                &quot;username&quot;: account,
                &quot;password&quot;: password
            }
        ).json()
        self._check_response_status(login_status)

    def get_user_info(self):
        &quot;&quot;&quot;
        获取个人信息
        &quot;&quot;&quot;
        user_info = self.session.get(self._urljoin(&quot;api/v1/common/user/&quot;)).json()
        user_info = self._check_response_status(user_info)
        # 对用户信息做缓存用于得到接口的默认user_id参数
        self.user = user_info
        return user_info

    def get_checkin_date(self):
        &quot;&quot;&quot;
        获取当前打卡日期
        &quot;&quot;&quot;
        checkin_date = self.session.get(self._urljoin(&quot;/api/v1/checkin/date/&quot;)).json()
        return self._check_response_status(checkin_date)

    def get_checkins(self, year=None, month=None, user_id=None, v=3):
        &quot;&quot;&quot;
        获取打卡日历
        :param year: 年份, 不提供时为当前年份
        :param month: 月份, 不提供时为当前月份
        :param user_id: 用户ID, 不提供时为登陆用户id
        :param v: 返回的结果详细程度,
            1 只返回相应日期是否打卡
            3 返回相应日期的打卡id和打卡天数, 没打卡则为空
            2 在 3 的基础上添加了分享相关的数据
        &quot;&quot;&quot;
        d = datetime.today()
        if year is None:
            year = d.year
        if month is None:
            month = d.month
        if user_id is None:
            user_id = self.user[&quot;user_id&quot;]
        checkins = self.session.get(
            self._urljoin(&quot;api/v1/checkin/user/%s/&quot; % user_id),
            params={&quot;year&quot;: year, &quot;month&quot;: month, &quot;v&quot;: v}
        ).json()
        checkins = self._check_response_status(checkins)
        return checkins

    def get_checkin_detail(self, checkin_id, user_id=None):
        &quot;&quot;&quot;
        获取打卡详情
        :param checkin_id: 打卡记录id
        :param user_id: 用户ID, 不提供时为登陆用户id
        &quot;&quot;&quot;
        if user_id is None:
            user_id = self.user[&quot;user_id&quot;]
        checkin_detail = self.session.get(self._urljoin(&quot;/api/v1/checkin/{}/{}/&quot;.format(user_id, checkin_id))).json()
        checkin_detail = self._check_response_status(checkin_detail)
        return checkin_detail

    def export2ical(self, use_todo=True):
        &quot;&quot;&quot;
        将打卡记录导出为ical
        :param use_todo: 是否使用 TODO 作为记录, false 时使用 Event 作为记录
        :return:
        &quot;&quot;&quot;
        cls = icalendar.Todo if use_todo else icalendar.Event
        # https://zh.wikipedia.org/wiki/ICalendar
        # http://icalendar.readthedocs.io/en/latest
        # https://tools.ietf.org/html/rfc5545
        cal = icalendar.Calendar()
        cal.add(&quot;X-WR-TIMEZONE&quot;, self.get_checkin_date()[&quot;timezone&quot;])
        cal.add('X-WR-CALNAME', &quot;{[nickname]}的扇贝打卡日历&quot;.format(self.user))

        d = datetime.today()
        year = d.year
        month = d.month
        # 扇贝 2011 才创立
        day = (year - 2011 + 1) * 365
        # 记录计数, 用于确认实际导出数量与服务器记录天数一致
        count = 0
        # 当打卡天数更新到第一天时表示所有记录已导出
        while day != 1:
            logger.info(&quot;获取{}年{}月的打卡详情&quot;.format(year, month))
            checks = self.get_checkins(year, month)
            dates = sorted(checks.keys(), reverse=True)
            for c in checks.values():
                # 没有打卡的天数内容为空
                if not c:
                    continue
                checkin_detail = self.get_checkin_detail(c[&quot;id&quot;])
                day = min(day, checkin_detail[&quot;num_checkin_days&quot;])
                # &quot;事件&quot;组件更具通用性, Google 日历不支持&quot;待办&quot;组件
                item = cls(
                    SUMMARY=&quot;扇贝打卡-{}&quot;.format(checkin_detail[&quot;num_checkin_days&quot;]),
                    # 开始时间为打卡当天零点
                    DTSTART=icalendar.vDatetime(datetime.strptime(checkin_detail[&quot;checkin_date&quot;], &quot;%Y-%m-%d&quot;)),
                    # 结束时间为打卡时间
                    DTEND=icalendar.vDatetime(datetime.strptime(checkin_detail[&quot;checkin_time&quot;], &quot;%Y-%m-%dT%H:%M:%S&quot;)),
                    # 任务描述为打卡时间统计与打卡日记
                    DESCRIPTION=&quot;{}\n{}&quot;.format(checkin_detail[&quot;info&quot;], checkin_detail[&quot;note&quot;])
                )
                # https://tools.ietf.org/html/rfc5545#section-3.2.12
                if use_todo:
                    item.add(&quot;STATUS&quot;, &quot;COMPLETED&quot;)
                else:
                    item.add(&quot;STATUS&quot;, &quot;ACCEPTED&quot;)
                cal.add_component(item)
                count += 1
            # 当前月份记录已添加, 月份调整到上一个月份
            month -= 1
            # 当月份为0表示本年度记录已添加, 月份由1月调整到上一个月份, 即12月, 年份相应的上调一年
            if month == 0:
                month = 12
                year -= 1
        # 检查导出记录数量是否与服务器记录天数一致
        assert count == self.user[&quot;checkin_days&quot;]
        logger.info(&quot;共导出 {} 条打卡记录&quot;.format(count))
        return cal


if __name__ == '__main__':
    sb = Shanbay(&quot;扇贝账号&quot;, &quot;密码&quot;)
    cal = sb.export2ical()
    with open('shanbay.ics', 'wb') as fp:
        fp.write(cal.to_ical())

</code></pre><p>如果你想将你打卡日历导出，只需将最下面的“扇贝账号”，“密码”替换成你响应的账号密码后运行此脚本，即可在当前目录获得导出的<code>shanbay.ics</code>文件。</p><p>以嘀嗒清单为例，导入步骤如下图:</p><p><img src=img/chrome_2017-03-25_15-59-57.png alt=chrome_2017-03-25_15-59-57></p><p>需要注意的是，导入到的清单最好是一个新建的空白清单，因为导入到非空清单后你要是想重新导入需要删除原来的数据。</p><p>最终的使用效果:</p><p><img src=img/chrome_2017-03-25_16-09-01.png alt=chrome_2017-03-25_16-09-01></p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=//earlzo.me/tags/%E6%89%87%E8%B4%9D/ rel=tag>扇贝</a></li><li class=tags__item><a class="tags__link btn" href=//earlzo.me/tags/%E6%97%A5%E5%8E%86/ rel=tag>日历</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="earlzo avatar" src=//earlzo.me/img/avatar.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>关于 earlzo</span></div><div class=authorbox__description>一个傻子</div></div><nav class="post-nav flex"><div class="post-nav__item post-nav__item--prev"><a class=post-nav__link href=//earlzo.me/post/jupyter-notebook-%E5%89%8D%E7%AB%AF%E4%BA%A4%E4%BA%92%E9%83%A8%E4%BB%B6%E5%AE%9E%E7%8E%B0/ rel=prev><span class=post-nav__caption>«&thinsp;上一篇</span><p class=post-nav__post-title>Jupyter Notebook 前端交互部件实现</p></a></div><div class="post-nav__item post-nav__item--next"><a class=post-nav__link href=//earlzo.me/post/http%E8%AF%B7%E6%B1%82%E6%8C%87%E7%BA%B9%E7%9A%84%E8%AE%A1%E7%AE%97/ rel=next><span class=post-nav__caption>下一篇&thinsp;»</span><p class=post-nav__post-title>HTTP请求指纹的计算</p></a></div></nav><section class=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"earlzo"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><aside class=sidebar><div class="widget-search widget"><form class=widget-search__form role=search method=get action=https://google.com/search><label><input class=widget-search__field type=search placeholder=搜索... name=q aria-label=搜索...></label>
<input class=widget-search__submit type=submit value=Search>
<input type=hidden name=sitesearch value=//earlzo.me/></form></div><div class="widget-recent widget"><h4 class=widget__title>近期文章</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=//earlzo.me/post/%E4%B8%83%E5%91%A8%E4%B8%83%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>数据库选择和实现的微妙平衡 - 《七周七数据库》读书笔记</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/post/%E5%A5%87%E7%89%B9%E7%9A%84%E4%B8%80%E7%94%9F%E4%B9%A6%E8%AF%84/>《奇特的一生》书评</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/post/http%E8%AF%B7%E6%B1%82%E6%8C%87%E7%BA%B9%E7%9A%84%E8%AE%A1%E7%AE%97/>HTTP请求指纹的计算</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/post/%E4%BD%BF%E7%94%A8python%E5%AF%BC%E5%87%BA%E6%89%87%E8%B4%9D%E5%BA%94%E7%94%A8%E6%89%93%E5%8D%A1%E6%97%A5%E5%8E%86/>使用Python导出扇贝应用打卡日历</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/post/jupyter-notebook-%E5%89%8D%E7%AB%AF%E4%BA%A4%E4%BA%92%E9%83%A8%E4%BB%B6%E5%AE%9E%E7%8E%B0/>Jupyter Notebook 前端交互部件实现</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>分类</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=//earlzo.me/categories/go/>Go</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/categories/python/>Python</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/>读书笔记</a></li><li class=widget__item><a class=widget__link href=//earlzo.me/categories/%E9%98%85%E8%AF%BB/>阅读</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>标签</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/http/ title=HTTP>HTTP (1)</a>
<a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/jupyter/ title=Jupyter>Jupyter (1)</a>
<a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/%E5%93%88%E5%B8%8C/ title=哈希>哈希 (1)</a>
<a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/%E5%BE%AE%E4%BF%A1%E8%AF%BB%E4%B9%A6/ title=微信读书>微信读书 (1)</a>
<a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/%E5%BE%AE%E4%BF%A1%E8%AF%BB%E4%B9%A6%E4%B8%83%E5%91%A8%E4%B8%83%E6%95%B0%E6%8D%AE%E5%BA%93/ title=微信读书，《七周七数据库》>微信读书，《七周七数据库》 (1)</a>
<a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/%E6%89%87%E8%B4%9D/ title=扇贝>扇贝 (1)</a>
<a class="widget-taglist__link widget__link btn" href=//earlzo.me/tags/%E6%97%A5%E5%8E%86/ title=日历>日历 (1)</a></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">社交</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/earlzo target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg><span>GitHub</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2019 earlzo.
<span class=footer__copyright-credits>基于 <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> 引擎和 <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a>主題</span></div></div></footer></div><script async defer src=//earlzo.me/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>